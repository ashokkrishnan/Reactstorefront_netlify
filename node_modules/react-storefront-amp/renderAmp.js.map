{"version":3,"sources":["../src/renderAmp.js"],"names":["INVALID_CSS_CLASS_REGEX","removeInvalidCssClasses","sheets","sheetsRegistry","registry","forEach","reg","invalidKeys","Object","keys","rules","map","filter","key","includes","replacementKey","replace","styleIndex","index","find","idx","selectorText","options","selector","renderAmp","document","currentUrl","imageService","$","cheerio","load","html","imagesThatNeedSizes","attr","process","env","NODE_ENV","remove","each","i","el","$el","expressions","split","expression","name","value","removeAttr","img","$img","attribs","prop","styleId","inlineStyles","Map","styles","style","className","get","set","push","addClass","_","$ampImg","startsWith","replaceWith","src","url","URL","parse","height","width","console","log","prepend","validSheets","head","toString","concat","join"],"mappings":"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","sourcesContent":["import React from 'react'\nimport cheerio from 'cheerio'\nimport { renderAmpAnalyticsTags } from 'react-storefront-analytics'\nimport batchPromises from './utils/batchPromises'\nimport getImageSize from './utils/getImageSize'\nimport { absoluteURL } from './utils/url'\nimport URL from 'url'\n\nconst INVALID_CSS_CLASS_REGEX = /\\.i-(amphtml[^\\s.]*)/g\n\nexport const removeInvalidCssClasses = sheets => {\n  sheets.sheetsRegistry.registry.forEach(reg => {\n    const invalidKeys = Object.keys(reg.rules.map).filter(key => key.includes('.i-amphtml'))\n    invalidKeys.forEach(key => {\n      const replacementKey = key.replace(INVALID_CSS_CLASS_REGEX, '[class*=\"$1\"]')\n      reg.rules.map[replacementKey] = reg.rules.map[key]\n      const styleIndex = reg.rules.index.find(idx => idx.key === key)\n      styleIndex.key = styleIndex.selectorText = styleIndex.options.selector = replacementKey\n      delete reg.rules.map[key]\n    })\n  })\n  return sheets\n}\n\nexport default async function renderAmp(document, sheets, currentUrl, { imageService } = {}) {\n  // $('img').attr({ height: '64', width: '64' })\n  // document.html = $('body').html()\n\n  const $ = cheerio.load(document.html)\n\n  const imagesThatNeedSizes = []\n\n  // Add ⚡ to html\n  $('html').attr('⚡', '')\n\n  if (process.env.NODE_ENV === 'development') {\n    $('html').attr('data-ampdevmode', '')\n  }\n\n  // remove default css rendering\n  $('#ssr-css').remove()\n\n  $('*[amp-bind]').each((i, el) => {\n    const $el = $(el)\n    const expressions = $el.attr('amp-bind').split(/,\\s*/)\n\n    for (let expression of expressions) {\n      const [name, value] = expression.split('->')\n      $el.attr(`[${name}]`, value)\n    }\n\n    $el.removeAttr('amp-bind')\n  })\n\n  $('amp-img').each((i, img) => {\n    const $img = $(img)\n    $img.attr('class', $img.attr('class') + ' ' + $img.attr('classname'))\n    $img.removeAttr('classname')\n  })\n\n  // replace attr=\"true\" with attr\n  $('*').each((i, el) => {\n    const $el = $(el)\n    for (let name in el.attribs) {\n      const value = el.attribs[name]\n      if (value === 'true') {\n        $el.attr(name, '')\n      }\n    }\n  })\n\n  // Add tabindex and role to all elements with `on` that are not `button` or `a`\n  $('[on]').each((i, el) => {\n    const $el = $(el)\n\n    if (!['button', 'a'].includes($el.prop('tagName'))) {\n      if ($el.attr('tabindex') == null) {\n        $el.attr('tabindex', '0')\n      }\n\n      if ($el.attr('role') == null) {\n        $el.attr('role', 'button')\n      }\n    }\n  })\n\n  $('*[classname]').each((i, el) => {\n    const $el = $(el)\n    $el.attr('class', $el.attr('classname'))\n    $el.removeAttr('classname')\n  })\n\n  // remove invalid attributes on all svg elements\n  $('svg[focusable]').removeAttr('focusable')\n  $('svg[xlink]').removeAttr('xlink')\n  $('svg[alt]').removeAttr('alt')\n\n  // material-ui puts this on tab underlines\n  $('div[direction]').removeAttr('direction')\n\n  let styleId = 0\n  const inlineStyles = new Map()\n  const styles = []\n\n  // move all inline styles to classes in the main style tag\n  $('*[style]').each((i, el) => {\n    const $el = $(el)\n    const style = $el.attr('style')\n    let className = inlineStyles.get(style)\n\n    if (!className) {\n      className = `mi${styleId++}`\n      inlineStyles.set(style, className)\n      styles.push(`.${className} {${style}}`)\n    }\n    $el.removeAttr('style')\n    $el.addClass(className)\n  })\n\n  // replace all img tags with amp-img\n  $('img').each((_, img) => {\n    const $img = $(img)\n    const $ampImg = $('<amp-img layout=\"intrinsic\"></amp-img>')\n    if ($img.attr('src')) $ampImg.attr('src', $img.attr('src'))\n    if ($img.attr('alt')) $ampImg.attr('alt', $img.attr('alt'))\n    if ($img.attr('height')) $ampImg.attr('height', $img.attr('height'))\n    if ($img.attr('width')) $ampImg.attr('width', $img.attr('width'))\n    if ($img.attr('data-height')) $ampImg.attr('height', $img.attr('data-height'))\n    if ($img.attr('data-width')) $ampImg.attr('width', $img.attr('data-width'))\n    for (let name in img.attribs) {\n      if (name.startsWith('data-amp-')) {\n        $ampImg.attr(name.replace(/^data-amp-/, ''), img.attribs[name])\n      }\n    }\n    $img.replaceWith($ampImg)\n  })\n\n  // All img tags need a height and width in AMP.  If those are missing, call moovweb's image size service\n  // to get the height and width and assign it to the image.\n  $('amp-img').each((_, img) => {\n    const $img = $(img)\n\n    if ($img.attr('layout') == 'fill') {\n      return\n    } else if (!$img.attr('height') || !$img.attr('width')) {\n      imagesThatNeedSizes.push($img)\n    }\n  })\n\n  // Fetch sizes for images that are missing a height and width in batches of 10 concurrently.\n  await batchPromises(10, imagesThatNeedSizes, async $img => {\n    const src = $img.attr('src')\n    try {\n      const url = src.startsWith('data:') ? src : absoluteURL(src, URL.parse(currentUrl))\n      const { height, width } = await getImageSize(url, imageService)\n      $img.attr('height', height)\n      $img.attr('width', width)\n    } catch (e) {\n      console.log(`warning: could not get height and width for ${src}`, e)\n    }\n  })\n\n  $('body')\n    .addClass('moov-amp')\n    .prepend(renderAmpAnalyticsTags())\n\n  document.html = $.html()\n\n  // replaces any CSS selectors starting with '.i-amphtml-(etc)' with 'class*=[\"amphtml-(etc)\"]'\n  const validSheets = removeInvalidCssClasses(sheets)\n\n  document.head.push(\n    <meta\n      key={'amp-google-client-id-api'}\n      name=\"amp-google-client-id-api\"\n      content=\"googleanalytics\"\n    />,\n    <script\n      key={'amp-analytics'}\n      async\n      custom-element=\"amp-analytics\"\n      src=\"https://cdn.ampproject.org/v0/amp-analytics-0.1.js\"\n    />,\n    <style\n      amp-custom={validSheets\n        .toString()\n        .replace(/\\!important/g, '')\n        .concat(styles.join(''))}\n      key={'amp-custom'}\n    />,\n  )\n\n  return document\n}\n"],"file":"renderAmp.js"}